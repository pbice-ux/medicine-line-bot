require("dotenv").config();
const express = require("express");
const axios = require("axios");
const { Redis } = require("@upstash/redis");
const cron = require("node-cron");

const app = express();
app.use(express.json());

// ===== Redis Setup =====
const redis = new Redis({
  url: process.env.UPSTASH_REDIS_URL,
  token: process.env.UPSTASH_REDIS_TOKEN,
});

// ===== LINE Setup =====
const LINE_API = "https://api.line.me/v2/bot/message";
const TOKEN = process.env.LINE_CHANNEL_ACCESS_TOKEN;

// ===== User States =====
const userStates = {};

// ==================== LINE Functions ====================
async function reply(replyToken, text) {
  try {
    await axios.post(
      `${LINE_API}/reply`,
      {
        replyToken,
        messages: [{ type: "text", text }],
      },
      {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${TOKEN}`,
        },
      }
    );
  } catch (error) {
    console.error("âŒ Reply Error:", error.response?.data || error.message);
  }
}

async function push(userId, text) {
  try {
    await axios.post(
      `${LINE_API}/push`,
      {
        to: userId,
        messages: [{ type: "text", text }],
      },
      {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${TOKEN}`,
        },
      }
    );
  } catch (error) {
    console.error("âŒ Push Error:", error.response?.data || error.message);
  }
}

// ==================== Redis Functions ====================
async function getUser(lineUserId) {
  try {
    const data = await redis.get(`user:${lineUserId}`);
    if (!data) return null;
    return typeof data === "string" ? JSON.parse(data) : data;
  } catch (error) {
    console.error("âŒ Redis Get Error:", error.message);
    return null;
  }
}

async function saveUser(lineUserId, userData) {
  try {
    await redis.set(`user:${lineUserId}`, JSON.stringify(userData));
  } catch (error) {
    console.error("âŒ Redis Save Error:", error.message);
  }
}

async function deleteUserData(lineUserId) {
  try {
    await redis.del(`user:${lineUserId}`);
  } catch (error) {
    console.error("âŒ Redis Delete Error:", error.message);
  }
}

async function getAllUsers() {
  try {
    const keys = await redis.keys("user:*");
    const users = [];
    for (const key of keys) {
      const data = await redis.get(key);
      if (data) {
        const user = typeof data === "string" ? JSON.parse(data) : data;
        users.push(user);
      }
    }
    return users;
  } catch (error) {
    console.error("âŒ Redis GetAll Error:", error.message);
    return [];
  }
}

// ==================== Reminder System ====================
function startReminderSystem() {
  cron.schedule(
    "* * * * *",
    async () => {
      const now = new Date();
      const currentTime = `${String(now.getHours()).padStart(2, "0")}:${String(
        now.getMinutes()
      ).padStart(2, "0")}`;

      try {
        const users = await getAllUsers();

        for (const user of users) {
          const times = user.reminderTimes || ["08:00", "20:00"];
          if (times.includes(currentTime)) {
            const timeIndex = times.indexOf(currentTime);
            await sendDrugReminder(user, currentTime, timeIndex + 1, timeIndex);
          }
        }
      } catch (error) {
        console.error("âŒ Reminder Error:", error.message);
      }
    },
    { timezone: "Asia/Bangkok" }
  );

  console.log("âœ… Reminder system started");
}

async function sendDrugReminder(user, time, timeNumber, timeIndex) {
  const drugs = user.drugs || [];

  // à¸à¸£à¸­à¸‡à¹€à¸‰à¸à¸²à¸°à¸¢à¸²à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸´à¸™à¹€à¸§à¸¥à¸²à¸™à¸µà¹‰
  const drugsToTake = drugs.filter((drug) => {
    const schedules = drug.schedules || [];
    return schedules.some((s) => s.times.includes(timeIndex));
  });

  if (drugsToTake.length === 0) {
    return; // à¹„à¸¡à¹ˆà¸¡à¸µà¸¢à¸²à¸•à¹‰à¸­à¸‡à¸à¸´à¸™
  }

  let warning = "";
  let drugList = "";

  drugsToTake.forEach((drug) => {
    const schedule = drug.schedules.find((s) => s.times.includes(timeIndex));
    const pills = schedule ? schedule.pills : 1;

    drugList += `ğŸ’Š ${drug.name} - à¸à¸´à¸™ ${pills} à¹€à¸¡à¹‡à¸” (à¹€à¸«à¸¥à¸·à¸­ ${drug.quantity} à¹€à¸¡à¹‡à¸”)\n`;

    if (drug.quantity <= 0) {
      warning += `\nğŸš« ${drug.name}: à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§!`;
    } else if (drug.quantity <= pills * 5) {
      warning += `\nğŸ”´ ${drug.name}: à¹€à¸«à¸¥à¸·à¸­ ${drug.quantity} à¹€à¸¡à¹‡à¸” (à¹ƒà¸à¸¥à¹‰à¸«à¸¡à¸”!)`;
    } else if (drug.quantity <= pills * 10) {
      warning += `\nğŸŸ¡ ${drug.name}: à¹€à¸«à¸¥à¸·à¸­ ${drug.quantity} à¹€à¸¡à¹‡à¸” (à¹€à¸«à¸¥à¸·à¸­à¸™à¹‰à¸­à¸¢)`;
    }
  });

  const message = `â° à¸–à¸¶à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²à¹à¸¥à¹‰à¸§!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ• à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ ${timeNumber}: ${time} à¸™.

ğŸ“‹ à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸´à¸™:
${drugList}${warning ? `\nâš ï¸ à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™:${warning}` : ""}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ à¸§à¸´à¸˜à¸µà¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸à¸´à¸™à¸¢à¸²:

âœ… à¸à¸´à¸™à¸•à¸£à¸‡à¹€à¸§à¸¥à¸²:
   à¸à¸´à¸¡à¸à¹Œ "à¸à¸´à¸™à¸¢à¸² ${timeNumber}"

â° à¸à¸´à¸™à¸Šà¹‰à¸²à¹€à¸à¸´à¸™ 30 à¸™à¸²à¸—à¸µ:
   à¸à¸´à¸¡à¸à¹Œ "à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸² ${timeNumber}"`;

  await push(user.lineUserId, message);
  console.log(`ğŸ“¤ Reminder sent to ${user.odotId} at ${time}`);
}

// ==================== Message Handler ====================
async function handleMessage(event) {
  const lineUserId = event.source.userId;
  const text = event.message.text.trim();
  const replyToken = event.replyToken;

  try {
    if (userStates[lineUserId]) {
      return await handleUserState(replyToken, lineUserId, text);
    }

    if (text === "help" || text === "à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰" || text === "à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­") {
      return await sendMainHelp(replyToken);
    }
    if (text.startsWith("help ") || text.startsWith("à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­ ")) {
      const topic = text.replace(/^(help |à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­ )/, "").trim();
      return await sendTopicHelp(replyToken, topic);
    }

    if (text.startsWith("à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ ")) {
      return await handleRegister(replyToken, text, lineUserId);
    }

    if (text.startsWith("à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² ")) {
      return await handleAddDrug(replyToken, text, lineUserId);
    }

    if (text === "à¸”à¸¹à¸¢à¸²" || text === "à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²") {
      return await handleShowDrugs(replyToken, lineUserId);
    }

    if (text === "à¹€à¸•à¸´à¸¡à¸¢à¸²") {
      return await handleRefillStart(replyToken, lineUserId);
    }
    if (text.startsWith("à¹€à¸•à¸´à¸¡à¸¢à¸² ")) {
      return await handleRefill(replyToken, text, lineUserId);
    }

    if (text === "à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸²") {
      return await handleCancelStart(replyToken, lineUserId);
    }
    if (text.startsWith("à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸² ")) {
      return await handleCancel(replyToken, text, lineUserId);
    }

    if (text === "à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²" || text === "à¸”à¸¹à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²") {
      return await handleShowTimes(replyToken, lineUserId);
    }
    if (text.startsWith("à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² ")) {
      return await handleAddTime(replyToken, text, lineUserId);
    }
    if (text.startsWith("à¸¥à¸šà¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² ")) {
      return await handleRemoveTime(replyToken, text, lineUserId);
    }

    // à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² (à¹ƒà¸«à¸¡à¹ˆ)
    if (text === "à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²") {
      return await handleSetScheduleStart(replyToken, lineUserId);
    }
    if (text.startsWith("à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² ")) {
      return await handleSetSchedule(replyToken, text, lineUserId);
    }

    if (text.startsWith("à¸à¸´à¸™à¸¢à¸² ") && !text.startsWith("à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸²")) {
      return await handleTakeDrug(replyToken, text, lineUserId, false);
    }

    if (text === "à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸²") {
      return await handleLateStart(replyToken, lineUserId);
    }
    if (text.startsWith("à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸² ")) {
      return await handleTakeDrug(replyToken, text, lineUserId, true);
    }

    if (text === "à¸£à¸µà¹€à¸‹à¹‡à¸—" || text === "à¸£à¸µà¹€à¸‹à¹‡à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥") {
      return await handleResetStart(replyToken, lineUserId);
    }
    if (text === "à¸¢à¸·à¸™à¸¢à¸±à¸™à¸£à¸µà¹€à¸‹à¹‡à¸—") {
      return await handleResetConfirm(replyToken, lineUserId);
    }

    return await reply(
      replyToken,
      `â“ à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸„à¹ˆà¸°\n\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "help" à¸«à¸£à¸·à¸­ "à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰" à¸”à¸¹à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”`
    );
  } catch (error) {
    console.error("âŒ Error:", error.message);
    return await reply(replyToken, "âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸” à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸„à¹ˆà¸°");
  }
}

// ==================== User State Handler ====================
async function handleUserState(replyToken, lineUserId, text) {
  const state = userStates[lineUserId];

  if (state.action === "confirmCancel") {
    if (text === "à¸¢à¸·à¸™à¸¢à¸±à¸™" || text === "à¹ƒà¸Šà¹ˆ" || text.toLowerCase() === "y") {
      const user = await getUser(lineUserId);
      const drugName = user.drugs[state.drugIndex].name;
      user.drugs.splice(state.drugIndex, 1);
      await saveUser(lineUserId, user);
      delete userStates[lineUserId];

      return await reply(replyToken, `âœ… à¸¥à¸šà¸¢à¸² "${drugName}" à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°`);
    } else {
      delete userStates[lineUserId];
      return await reply(replyToken, "âŒ à¸¢à¸à¹€à¸¥à¸´à¸à¸à¸²à¸£à¸¥à¸šà¸¢à¸²à¸„à¹ˆà¸°");
    }
  }

  if (state.action === "confirmReset") {
    if (text === "à¸¢à¸·à¸™à¸¢à¸±à¸™à¸£à¸µà¹€à¸‹à¹‡à¸—") {
      await deleteUserData(lineUserId);
      delete userStates[lineUserId];

      return await reply(
        replyToken,
        `âœ… à¸£à¸µà¹€à¸‹à¹‡à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ”„ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸–à¸¹à¸à¸¥à¸šà¹à¸¥à¹‰à¸§\n\nğŸ’¡ à¹€à¸£à¸´à¹ˆà¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹ƒà¸«à¸¡à¹ˆ:\nà¸à¸´à¸¡à¸à¹Œ: à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ [à¸£à¸«à¸±à¸ªà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢]`
      );
    } else {
      delete userStates[lineUserId];
      return await reply(replyToken, "âŒ à¸¢à¸à¹€à¸¥à¸´à¸à¸à¸²à¸£à¸£à¸µà¹€à¸‹à¹‡à¸—à¸„à¹ˆà¸°");
    }
  }

  delete userStates[lineUserId];
  return null;
}

// ==================== HELP Functions ====================
async function sendMainHelp(replyToken) {
  const text = `ğŸ“š à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸‡à¸²à¸™ Bot à¹€à¸•à¸·à¸­à¸™à¸à¸´à¸™à¸¢à¸²
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸°! ğŸ‘‹
Bot à¸™à¸µà¹‰à¸ˆà¸°à¸Šà¹ˆà¸§à¸¢à¹€à¸•à¸·à¸­à¸™à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²
à¹à¸¥à¸°à¸ˆà¸±à¸”à¸à¸²à¸£à¸¢à¸²à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¹ˆà¸°

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆà¸„à¸³à¸ªà¸±à¹ˆà¸‡:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1ï¸âƒ£ à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ â†’ help à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™
2ï¸âƒ£ à¸ˆà¸±à¸”à¸à¸²à¸£à¸¢à¸² â†’ help à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²
3ï¸âƒ£ à¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸§à¸¥à¸² â†’ help à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²
4ï¸âƒ£ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¹à¸•à¹ˆà¸¥à¸°à¸¢à¸² â†’ help à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²
5ï¸âƒ£ à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸à¸´à¸™ â†’ help à¸à¸´à¸™à¸¢à¸²
6ï¸âƒ£ à¸£à¸µà¹€à¸‹à¹‡à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ â†’ help à¸£à¸µà¹€à¸‹à¹‡à¸—

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸”à¹ˆà¸§à¸™:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ à¸”à¸¹à¸¢à¸² - à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
â€¢ à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² - à¸”à¸¹à¹€à¸§à¸¥à¸²à¹€à¸•à¸·à¸­à¸™
â€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² - à¸à¸³à¸«à¸™à¸”à¸§à¹ˆà¸²à¸¢à¸²à¹„à¸«à¸™à¸à¸´à¸™à¹€à¸§à¸¥à¸²à¹„à¸«à¸™
â€¢ à¹€à¸•à¸´à¸¡à¸¢à¸² - à¹€à¸•à¸´à¸¡à¸ˆà¸³à¸™à¸§à¸™à¸¢à¸²

ğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "help [à¸«à¸¡à¸§à¸”]" à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”`;

  return await reply(replyToken, text);
}

async function sendTopicHelp(replyToken, topic) {
  const helps = {
    à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™: `ğŸ“ à¸§à¸´à¸˜à¸µà¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¹ à¸„à¸³à¸ªà¸±à¹ˆà¸‡:
à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ [à¸£à¸«à¸±à¸ªà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢]

ğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ HN12345

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… à¸«à¸¥à¸±à¸‡à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™:
â€¢ à¹€à¸§à¸¥à¸²à¹€à¸•à¸·à¸­à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™: 08:00, 20:00
â€¢ à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²à¹„à¸”à¹‰à¹€à¸¥à¸¢
â€¢ à¸£à¸°à¸šà¸šà¸ˆà¸°à¹€à¸•à¸·à¸­à¸™à¸•à¸²à¸¡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸•à¸±à¹‰à¸‡à¹„à¸§à¹‰`,

    à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²: `ğŸ’Š à¸§à¸´à¸˜à¸µà¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¹ à¸„à¸³à¸ªà¸±à¹ˆà¸‡:
à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² [à¸Šà¸·à¹ˆà¸­à¸¢à¸²] [à¸ˆà¸³à¸™à¸§à¸™]

ğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
â€¢ à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² à¸à¸²à¸£à¸²à¹€à¸‹à¸•à¸²à¸¡à¸­à¸¥ 30
â€¢ à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² à¸¢à¸²à¸¥à¸”à¸„à¸§à¸²à¸¡à¸”à¸±à¸™ 20
â€¢ à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² à¸§à¸´à¸•à¸²à¸¡à¸´à¸™à¸‹à¸µ 60

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¸‚à¸¶à¹‰à¸™:
â€¢ à¸¢à¸²à¸ˆà¸°à¸–à¸¹à¸à¹€à¸à¸´à¹ˆà¸¡à¹€à¸‚à¹‰à¸²à¸£à¸°à¸šà¸š
â€¢ à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™: à¸à¸´à¸™à¸—à¸¸à¸à¹€à¸§à¸¥à¸² 1 à¹€à¸¡à¹‡à¸”
â€¢ à¹ƒà¸Šà¹‰ "à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²" à¸›à¸£à¸±à¸šà¹à¸•à¹ˆà¸‡`,

    à¹€à¸•à¸´à¸¡à¸¢à¸²: `ğŸ“¦ à¸§à¸´à¸˜à¸µà¹€à¸•à¸´à¸¡à¸¢à¸²
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¹ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™:
1. à¸à¸´à¸¡à¸à¹Œ "à¹€à¸•à¸´à¸¡à¸¢à¸²"
2. à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¸à¸£à¹‰à¸­à¸¡à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚
3. à¸à¸´à¸¡à¸à¹Œ "à¹€à¸•à¸´à¸¡à¸¢à¸² [à¹€à¸¥à¸‚] [à¸ˆà¸³à¸™à¸§à¸™]"

ğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
Step 1: à¸à¸´à¸¡à¸à¹Œ "à¹€à¸•à¸´à¸¡à¸¢à¸²"
Step 2: à¸£à¸°à¸šà¸šà¹à¸ªà¸”à¸‡
  1. à¸à¸²à¸£à¸²à¸¯ (5 à¹€à¸¡à¹‡à¸”) ğŸ”´
  2. à¸¢à¸²à¸¥à¸”à¸„à¸§à¸²à¸¡à¸”à¸±à¸™ (15 à¹€à¸¡à¹‡à¸”)
Step 3: à¸à¸´à¸¡à¸à¹Œ "à¹€à¸•à¸´à¸¡à¸¢à¸² 1 30"

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ:
à¸¢à¸²à¹€à¸¥à¸‚ 1 à¸ˆà¸°à¸¡à¸µà¸ˆà¸³à¸™à¸§à¸™à¹€à¸à¸´à¹ˆà¸¡à¸‚à¸¶à¹‰à¸™ 30 à¹€à¸¡à¹‡à¸”`,

    à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸²: `ğŸ—‘ï¸ à¸§à¸´à¸˜à¸µà¸¢à¸à¹€à¸¥à¸´à¸/à¸¥à¸šà¸¢à¸²
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¹ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™:
1. à¸à¸´à¸¡à¸à¹Œ "à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸²"
2. à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¸à¸£à¹‰à¸­à¸¡à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚
3. à¸à¸´à¸¡à¸à¹Œ "à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸² [à¹€à¸¥à¸‚]"
4. à¸à¸´à¸¡à¸à¹Œ "à¸¢à¸·à¸™à¸¢à¸±à¸™" à¹€à¸à¸·à¹ˆà¸­à¸¥à¸š

ğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
Step 1: à¸à¸´à¸¡à¸à¹Œ "à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸²"
Step 2: à¸à¸´à¸¡à¸à¹Œ "à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸² 1"
Step 3: à¸£à¸°à¸šà¸šà¸–à¸²à¸¡à¸¢à¸·à¸™à¸¢à¸±à¸™
Step 4: à¸à¸´à¸¡à¸à¹Œ "à¸¢à¸·à¸™à¸¢à¸±à¸™"

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ à¸„à¸³à¹€à¸•à¸·à¸­à¸™:
à¸¥à¸šà¹à¸¥à¹‰à¸§à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸à¸¹à¹‰à¸„à¸·à¸™à¹„à¸”à¹‰!`,

    à¸”à¸¹à¸¢à¸²: `ğŸ“‹ à¸§à¸´à¸˜à¸µà¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¹ à¸„à¸³à¸ªà¸±à¹ˆà¸‡:
à¸”à¸¹à¸¢à¸² à¸«à¸£à¸·à¸­ à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¨ à¸„à¸§à¸²à¸¡à¸«à¸¡à¸²à¸¢à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œ:

âœ… à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§ (à¸›à¸à¸•à¸´)
   à¸¡à¸µà¸¢à¸²à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 10 à¹€à¸¡à¹‡à¸”

ğŸŸ¡ à¸ªà¸µà¹€à¸«à¸¥à¸·à¸­à¸‡ (à¹€à¸«à¸¥à¸·à¸­à¸™à¹‰à¸­à¸¢)
   à¸¡à¸µà¸¢à¸²à¹€à¸«à¸¥à¸·à¸­ 6-10 à¹€à¸¡à¹‡à¸”
   à¸„à¸§à¸£à¹€à¸•à¸£à¸µà¸¢à¸¡à¸‹à¸·à¹‰à¸­à¹€à¸à¸´à¹ˆà¸¡

ğŸ”´ à¸ªà¸µà¹à¸”à¸‡ (à¹ƒà¸à¸¥à¹‰à¸«à¸¡à¸”!)
   à¸¡à¸µà¸¢à¸²à¹€à¸«à¸¥à¸·à¸­à¹€à¸à¸µà¸¢à¸‡ 1-5 à¹€à¸¡à¹‡à¸”
   à¸•à¹‰à¸­à¸‡à¸‹à¸·à¹‰à¸­à¹€à¸à¸´à¹ˆà¸¡à¸”à¹ˆà¸§à¸™!

ğŸš« à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§
   à¹„à¸¡à¹ˆà¸¡à¸µà¸¢à¸²à¹€à¸«à¸¥à¸·à¸­à¹€à¸¥à¸¢ (0 à¹€à¸¡à¹‡à¸”)`,

    à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²: `â° à¸§à¸´à¸˜à¸µà¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¹ à¸”à¸¹à¹€à¸§à¸¥à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”:
à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² à¸«à¸£à¸·à¸­ à¸”à¸¹à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²

ğŸ”¹ à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¹ƒà¸«à¸¡à¹ˆ:
à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² [à¹€à¸§à¸¥à¸²]

ğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
â€¢ à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 12:00
â€¢ à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 18.30
â€¢ à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 06:00

ğŸ”¹ à¸¥à¸šà¹€à¸§à¸¥à¸²:
à¸¥à¸šà¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² [à¹€à¸¥à¸‚]

ğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
à¸¥à¸šà¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 3

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸:
â€¢ à¹€à¸§à¸¥à¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™: 08:00, 20:00
â€¢ à¹€à¸à¸´à¹ˆà¸¡à¹„à¸”à¹‰à¹„à¸¡à¹ˆà¸ˆà¸³à¸à¸±à¸”à¸ˆà¸³à¸™à¸§à¸™
â€¢ à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸«à¸¡à¸²à¸¢ : à¸«à¸£à¸·à¸­ . à¹„à¸”à¹‰
â€¢ à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 1 à¹€à¸§à¸¥à¸²`,

    à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²: `â° à¸§à¸´à¸˜à¸µà¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²à¹à¸•à¹ˆà¸¥à¸°à¸•à¸±à¸§
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¹ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™:
1. à¸à¸´à¸¡à¸à¹Œ "à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²"
2. à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¹à¸¥à¸°à¹€à¸§à¸¥à¸²
3. à¸à¸´à¸¡à¸à¹Œ "à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² [à¹€à¸§à¸¥à¸²] [à¹€à¸¥à¸‚à¸¢à¸²] [à¸ˆà¸³à¸™à¸§à¸™à¹€à¸¡à¹‡à¸”]"

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ à¸£à¸¹à¸›à¹à¸šà¸šà¸„à¸³à¸ªà¸±à¹ˆà¸‡:

à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² [à¹€à¸§à¸¥à¸²] [à¹€à¸¥à¸‚à¸¢à¸²] [à¸ˆà¸³à¸™à¸§à¸™à¹€à¸¡à¹‡à¸”]

ğŸ”¹ [à¹€à¸§à¸¥à¸²] = à¹€à¸¥à¸‚à¹€à¸§à¸¥à¸² (1, 2, 3...)
   - à¹ƒà¸Šà¹‰à¹€à¸¥à¸‚à¹€à¸”à¸µà¸¢à¸§: 1
   - à¹ƒà¸Šà¹‰à¸«à¸¥à¸²à¸¢à¹€à¸§à¸¥à¸²: 1,2

ğŸ”¹ [à¹€à¸¥à¸‚à¸¢à¸²] = à¹€à¸¥à¸‚à¸¥à¸³à¸”à¸±à¸šà¸¢à¸² (1, 2, 3...)
   - à¹ƒà¸Šà¹‰à¸¢à¸²à¹€à¸”à¸µà¸¢à¸§: 1
   - à¹ƒà¸Šà¹‰à¸«à¸¥à¸²à¸¢à¸¢à¸²: 1,2,3

ğŸ”¹ [à¸ˆà¸³à¸™à¸§à¸™à¹€à¸¡à¹‡à¸”] = à¸ˆà¸³à¸™à¸§à¸™à¹€à¸¡à¹‡à¸”à¸—à¸µà¹ˆà¸à¸´à¸™

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¹à¸šà¸šà¸‡à¹ˆà¸²à¸¢:

â€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1 1 2
  â†’ à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ 1, à¸¢à¸²à¹€à¸¥à¸‚ 1, à¸à¸´à¸™ 2 à¹€à¸¡à¹‡à¸”

â€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 2 3 1
  â†’ à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ 2, à¸¢à¸²à¹€à¸¥à¸‚ 3, à¸à¸´à¸™ 1 à¹€à¸¡à¹‡à¸”

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¹à¸šà¸šà¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™:

â€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1,2 1 2
  â†’ à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ 1 à¹à¸¥à¸° 2, à¸¢à¸²à¹€à¸¥à¸‚ 1, à¸à¸´à¸™ 2 à¹€à¸¡à¹‡à¸”

â€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1 1,2,3 1
  â†’ à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ 1, à¸¢à¸²à¹€à¸¥à¸‚ 1,2,3, à¸à¸´à¸™ 1 à¹€à¸¡à¹‡à¸”

â€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1,2 3,4 2
  â†’ à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ 1 à¹à¸¥à¸° 2, à¸¢à¸²à¹€à¸¥à¸‚ 3 à¹à¸¥à¸° 4, à¸à¸´à¸™ 2 à¹€à¸¡à¹‡à¸”

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¡ à¸à¸£à¸“à¸µà¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸ˆà¸£à¸´à¸‡:

à¸¡à¸µà¸¢à¸² 4 à¸•à¸±à¸§, à¹€à¸§à¸¥à¸² 2 à¹€à¸§à¸¥à¸² (08:00, 20:00)

à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:
- à¹€à¸Šà¹‰à¸²: à¸à¸²à¸£à¸²à¸¯ 2 à¹€à¸¡à¹‡à¸”, à¸§à¸´à¸•à¸²à¸¡à¸´à¸™ 1 à¹€à¸¡à¹‡à¸”
- à¹€à¸¢à¹‡à¸™: à¸¢à¸²à¸¥à¸”à¸„à¸§à¸²à¸¡à¸”à¸±à¸™ 1 à¹€à¸¡à¹‡à¸”

à¸§à¸´à¸˜à¸µà¸•à¸±à¹‰à¸‡:
1. à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1 1 2
   (à¹€à¸Šà¹‰à¸² à¸à¸´à¸™à¸à¸²à¸£à¸²à¸¯ 2 à¹€à¸¡à¹‡à¸”)

2. à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1 3 1
   (à¹€à¸Šà¹‰à¸² à¸à¸´à¸™à¸§à¸´à¸•à¸²à¸¡à¸´à¸™ 1 à¹€à¸¡à¹‡à¸”)

3. à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 2 2 1
   (à¹€à¸¢à¹‡à¸™ à¸à¸´à¸™à¸¢à¸²à¸¥à¸”à¸„à¸§à¸²à¸¡à¸”à¸±à¸™ 1 à¹€à¸¡à¹‡à¸”)`,

    à¸à¸´à¸™à¸¢à¸²: `âœ… à¸§à¸´à¸˜à¸µà¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸à¸´à¸™à¸¢à¸²
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
à¸¡à¸µ 2 à¹à¸šà¸š:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŸ¢ à¹à¸šà¸šà¸—à¸µà¹ˆ 1: à¸à¸´à¸™à¸•à¸£à¸‡à¹€à¸§à¸¥à¸²
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
à¹ƒà¸Šà¹‰à¹€à¸¡à¸·à¹ˆà¸­: à¸à¸´à¸™à¸¢à¸²à¸ à¸²à¸¢à¹ƒà¸™ 30 à¸™à¸²à¸—à¸µ
à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸£à¸°à¸šà¸šà¹€à¸•à¸·à¸­à¸™

ğŸ”¹ à¸„à¸³à¸ªà¸±à¹ˆà¸‡:
à¸à¸´à¸™à¸¢à¸² [à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¹€à¸§à¸¥à¸²]

ğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
â€¢ à¸à¸´à¸™à¸¢à¸² 1 = à¸à¸´à¸™à¸¢à¸²à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ 1 (08:00)
â€¢ à¸à¸´à¸™à¸¢à¸² 2 = à¸à¸´à¸™à¸¢à¸²à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ 2 (20:00)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŸ¡ à¹à¸šà¸šà¸—à¸µà¹ˆ 2: à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸²
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
à¹ƒà¸Šà¹‰à¹€à¸¡à¸·à¹ˆà¸­: à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸²à¹€à¸à¸´à¸™ 30 à¸™à¸²à¸—à¸µ

ğŸ”¹ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™:
1. à¸à¸´à¸¡à¸à¹Œ "à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸²"
2. à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸§à¸¥à¸²
3. à¸à¸´à¸¡à¸à¹Œ "à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸² [à¹€à¸¥à¸‚]"

ğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸² 1

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ:
â€¢ à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸à¸´à¸™à¸¢à¸²
â€¢ à¸ˆà¸³à¸™à¸§à¸™à¸¢à¸²à¸¥à¸”à¸¥à¸‡à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”
â€¢ à¹à¸ªà¸”à¸‡à¸ªà¸–à¸²à¸™à¸°à¸¢à¸²à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­`,

    à¸£à¸µà¹€à¸‹à¹‡à¸—: `ğŸ”„ à¸§à¸´à¸˜à¸µà¸£à¸µà¹€à¸‹à¹‡à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¹ à¸„à¸³à¸ªà¸±à¹ˆà¸‡:
à¸£à¸µà¹€à¸‹à¹‡à¸— à¸«à¸£à¸·à¸­ à¸£à¸µà¹€à¸‹à¹‡à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥

ğŸ”¹ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™:
1. à¸à¸´à¸¡à¸à¹Œ "à¸£à¸µà¹€à¸‹à¹‡à¸—"
2. à¸£à¸°à¸šà¸šà¸ˆà¸°à¸–à¸²à¸¡à¸¢à¸·à¸™à¸¢à¸±à¸™
3. à¸à¸´à¸¡à¸à¹Œ "à¸¢à¸·à¸™à¸¢à¸±à¸™à¸£à¸µà¹€à¸‹à¹‡à¸—"

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ˆà¸°à¸–à¸¹à¸à¸¥à¸š:

âŒ à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
âŒ à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²à¸—à¸µà¹ˆà¸•à¸±à¹‰à¸‡à¹„à¸§à¹‰
âŒ à¸•à¸²à¸£à¸²à¸‡à¸à¸´à¸™à¸¢à¸²
âŒ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ à¸„à¸³à¹€à¸•à¸·à¸­à¸™à¸ªà¸³à¸„à¸±à¸:
à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸¥à¸šà¹à¸¥à¹‰à¸§à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸à¸¹à¹‰à¸„à¸·à¸™à¹„à¸”à¹‰!
à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸à¹ˆà¸­à¸™à¸¢à¸·à¸™à¸¢à¸±à¸™

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… à¸«à¸¥à¸±à¸‡à¸£à¸µà¹€à¸‹à¹‡à¸—:
à¸•à¹‰à¸­à¸‡à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡
à¸à¸´à¸¡à¸à¹Œ: à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ [à¸£à¸«à¸±à¸ªà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢]`,
  };

  const text =
    helps[topic] ||
    `â“ à¹„à¸¡à¹ˆà¸à¸šà¸«à¸±à¸§à¸‚à¹‰à¸­ "${topic}"

ğŸ“š à¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸¡à¸µ:
â€¢ help à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™
â€¢ help à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²
â€¢ help à¹€à¸•à¸´à¸¡à¸¢à¸²
â€¢ help à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸²
â€¢ help à¸”à¸¹à¸¢à¸²
â€¢ help à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²
â€¢ help à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²
â€¢ help à¸à¸´à¸™à¸¢à¸²
â€¢ help à¸£à¸µà¹€à¸‹à¹‡à¸—

ğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "help" à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸ à¸²à¸à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”`;

  return await reply(replyToken, text);
}

// ==================== Register ====================
async function handleRegister(replyToken, text, lineUserId) {
  const odotId = text.replace("à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ ", "").trim();

  const existing = await getUser(lineUserId);
  if (existing) {
    return await reply(
      replyToken,
      `âŒ à¸„à¸¸à¸“à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°\nğŸ“‹ à¸£à¸«à¸±à¸ªà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢: ${existing.odotId}\n\nğŸ’¡ à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹€à¸£à¸´à¹ˆà¸¡à¹ƒà¸«à¸¡à¹ˆ:\nà¸à¸´à¸¡à¸à¹Œ: à¸£à¸µà¹€à¸‹à¹‡à¸—`
    );
  }

  const newUser = {
    odotId,
    lineUserId,
    drugs: [],
    reminderTimes: ["08:00", "20:00"],
    createdAt: new Date().toISOString(),
  };

  await saveUser(lineUserId, newUser);

  return await reply(
    replyToken,
    `âœ… à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ à¸£à¸«à¸±à¸ªà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢: ${odotId}
â° à¹€à¸§à¸¥à¸²à¹€à¸•à¸·à¸­à¸™: 08:00, 20:00

ğŸ’¡ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸•à¹ˆà¸­à¹„à¸›:
1. à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²: à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² [à¸Šà¸·à¹ˆà¸­] [à¸ˆà¸³à¸™à¸§à¸™]
2. à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²: à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²

ğŸ“š à¸”à¸¹à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰:
à¸à¸´à¸¡à¸à¹Œ: help`
  );
}

// ==================== Add Drug ====================
async function handleAddDrug(replyToken, text, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user) {
    return await reply(
      replyToken,
      `âŒ à¸à¸£à¸¸à¸“à¸²à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸à¹ˆà¸­à¸™à¸„à¹ˆà¸°\n\nà¸à¸´à¸¡à¸à¹Œ: à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ [à¸£à¸«à¸±à¸ªà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢]\nà¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ HN12345`
    );
  }

  const parts = text.replace("à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² ", "").trim().split(" ");
  if (parts.length < 2) {
    return await reply(
      replyToken,
      `âŒ à¸£à¸¹à¸›à¹à¸šà¸šà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¹ˆà¸°\n\nà¸à¸´à¸¡à¸à¹Œ: à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² [à¸Šà¸·à¹ˆà¸­à¸¢à¸²] [à¸ˆà¸³à¸™à¸§à¸™]\nà¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² à¸à¸²à¸£à¸²à¹€à¸‹à¸•à¸²à¸¡à¸­à¸¥ 30\n\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "help à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²" à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”`
    );
  }

  const quantity = parseInt(parts.pop());
  const name = parts.join(" ");

  if (isNaN(quantity) || quantity <= 0) {
    return await reply(
      replyToken,
      `âŒ à¸ˆà¸³à¸™à¸§à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¹ˆà¸°\nà¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 0`
    );
  }

  // à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™: à¸à¸´à¸™à¸—à¸¸à¸à¹€à¸§à¸¥à¸² 1 à¹€à¸¡à¹‡à¸”
  const times = user.reminderTimes || ["08:00", "20:00"];
  const defaultSchedule = {
    times: times.map((_, idx) => idx), // [0, 1]
    pills: 1,
  };

  user.drugs.push({
    name,
    quantity,
    schedules: [defaultSchedule],
  });
  await saveUser(lineUserId, user);

  return await reply(
    replyToken,
    `âœ… à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’Š à¸¢à¸²: ${name}
ğŸ“¦ à¸ˆà¸³à¸™à¸§à¸™: ${quantity} à¹€à¸¡à¹‡à¸”
â° à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™: à¸à¸´à¸™à¸—à¸¸à¸à¹€à¸§à¸¥à¸² 1 à¹€à¸¡à¹‡à¸”

ğŸ’¡ à¸›à¸£à¸±à¸šà¹€à¸§à¸¥à¸²/à¸ˆà¸³à¸™à¸§à¸™à¹€à¸¡à¹‡à¸”:
à¸à¸´à¸¡à¸à¹Œ: à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²`
  );
}

// ==================== Show Drugs ====================
async function handleShowDrugs(replyToken, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user) {
    return await reply(replyToken, `âŒ à¸à¸£à¸¸à¸“à¸²à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸à¹ˆà¸­à¸™à¸„à¹ˆà¸°`);
  }

  if (user.drugs.length === 0) {
    return await reply(
      replyToken,
      `ğŸ“‹ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸¢à¸²à¹ƒà¸™à¸£à¸°à¸šà¸šà¸„à¹ˆà¸°\n\nà¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²: à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² [à¸Šà¸·à¹ˆà¸­à¸¢à¸²] [à¸ˆà¸³à¸™à¸§à¸™]\nà¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² à¸à¸²à¸£à¸²à¹€à¸‹à¸•à¸²à¸¡à¸­à¸¥ 30`
    );
  }

  let list = `ğŸ“‹ à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¸‚à¸­à¸‡à¸„à¸¸à¸“:\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;

  user.drugs.forEach((drug, i) => {
    let icon = "âœ…";
    let note = "";

    // à¸„à¸³à¸™à¸§à¸“à¸ˆà¸²à¸ schedule à¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¸•à¹ˆà¸­à¸§à¸±à¸™à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ
    const dailyUse = drug.schedules.reduce((sum, s) => sum + (s.pills || 1), 0);

    if (drug.quantity <= 0) {
      icon = "ğŸš«";
      note = " â†’ à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§!";
    } else if (drug.quantity <= dailyUse * 5) {
      icon = "ğŸ”´";
      note = " â†’ à¹ƒà¸à¸¥à¹‰à¸«à¸¡à¸”!";
    } else if (drug.quantity <= dailyUse * 10) {
      icon = "ğŸŸ¡";
      note = " â†’ à¹€à¸«à¸¥à¸·à¸­à¸™à¹‰à¸­à¸¢";
    }

    list += `\n${i + 1}. ${icon} ${drug.name}\n   ğŸ“¦ ${drug.quantity} à¹€à¸¡à¹‡à¸”${note}\n`;
  });

  list += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡:\nâ€¢ à¹€à¸•à¸´à¸¡à¸¢à¸² - à¹€à¸•à¸´à¸¡à¸ˆà¸³à¸™à¸§à¸™à¸¢à¸²\nâ€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² - à¸”à¸¹à¸•à¸²à¸£à¸²à¸‡à¸à¸´à¸™à¸¢à¸²\nâ€¢ à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸² - à¸¥à¸šà¸¢à¸²`;

  return await reply(replyToken, list);
}

// ==================== Refill Drug ====================
async function handleRefillStart(replyToken, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user || user.drugs.length === 0) {
    return await reply(replyToken, `âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸¢à¸²à¹ƒà¸™à¸£à¸°à¸šà¸šà¸„à¹ˆà¸°`);
  }

  let list = `ğŸ“¦ à¹€à¸¥à¸·à¸­à¸à¸¢à¸²à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹€à¸•à¸´à¸¡:\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;

  user.drugs.forEach((drug, i) => {
    let icon = "";
    const dailyUse = drug.schedules.reduce((sum, s) => sum + (s.pills || 1), 0);

    if (drug.quantity <= 0) icon = " ğŸš«";
    else if (drug.quantity <= dailyUse * 5) icon = " ğŸ”´";
    else if (drug.quantity <= dailyUse * 10) icon = " ğŸŸ¡";

    list += `${i + 1}. ${drug.name} (${drug.quantity} à¹€à¸¡à¹‡à¸”)${icon}\n`;
  });

  list += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ à¸à¸´à¸¡à¸à¹Œ: à¹€à¸•à¸´à¸¡à¸¢à¸² [à¹€à¸¥à¸‚] [à¸ˆà¸³à¸™à¸§à¸™]\nà¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: à¹€à¸•à¸´à¸¡à¸¢à¸² 1 30`;

  return await reply(replyToken, list);
}

async function handleRefill(replyToken, text, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user) return;

  const parts = text.replace("à¹€à¸•à¸´à¸¡à¸¢à¸² ", "").trim().split(" ");
  if (parts.length < 2) {
    return await reply(
      replyToken,
      `âŒ à¸£à¸¹à¸›à¹à¸šà¸šà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¹ˆà¸°\n\nà¸à¸´à¸¡à¸à¹Œ: à¹€à¸•à¸´à¸¡à¸¢à¸² [à¹€à¸¥à¸‚] [à¸ˆà¸³à¸™à¸§à¸™]\n\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "à¹€à¸•à¸´à¸¡à¸¢à¸²" à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£à¸à¹ˆà¸­à¸™`
    );
  }

  const index = parseInt(parts[0]) - 1;
  const qty = parseInt(parts[1]);

  if (isNaN(index) || isNaN(qty) || qty <= 0) {
    return await reply(replyToken, `âŒ à¸•à¸±à¸§à¹€à¸¥à¸‚à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¹ˆà¸°`);
  }

  if (index < 0 || index >= user.drugs.length) {
    return await reply(
      replyToken,
      `âŒ à¹„à¸¡à¹ˆà¸à¸šà¸¢à¸²à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸™à¸µà¹‰à¸„à¹ˆà¸°\n\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "à¹€à¸•à¸´à¸¡à¸¢à¸²" à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£`
    );
  }

  user.drugs[index].quantity += qty;
  await saveUser(lineUserId, user);

  return await reply(
    replyToken,
    `âœ… à¹€à¸•à¸´à¸¡à¸¢à¸²à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’Š à¸¢à¸²: ${user.drugs[index].name}
ğŸ“¦ à¹€à¸•à¸´à¸¡à¹€à¸à¸´à¹ˆà¸¡: +${qty} à¹€à¸¡à¹‡à¸”
ğŸ“Š à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: ${user.drugs[index].quantity} à¹€à¸¡à¹‡à¸”`
  );
}

// ==================== Cancel Drug ====================
async function handleCancelStart(replyToken, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user || user.drugs.length === 0) {
    return await reply(replyToken, `âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸¢à¸²à¹ƒà¸™à¸£à¸°à¸šà¸šà¸„à¹ˆà¸°`);
  }

  let list = `ğŸ—‘ï¸ à¹€à¸¥à¸·à¸­à¸à¸¢à¸²à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸š:\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  user.drugs.forEach((drug, i) => {
    list += `${i + 1}. ${drug.name} (${drug.quantity} à¹€à¸¡à¹‡à¸”)\n`;
  });
  list += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ à¸à¸´à¸¡à¸à¹Œ: à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸² [à¹€à¸¥à¸‚]\nà¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸² 1\n\nâš ï¸ à¸¥à¸šà¹à¸¥à¹‰à¸§à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸à¸¹à¹‰à¸„à¸·à¸™à¹„à¸”à¹‰`;

  return await reply(replyToken, list);
}

async function handleCancel(replyToken, text, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user) return;

  const index = parseInt(text.replace("à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸² ", "").trim()) - 1;

  if (isNaN(index) || index < 0 || index >= user.drugs.length) {
    return await reply(
      replyToken,
      `âŒ à¹„à¸¡à¹ˆà¸à¸šà¸¢à¸²à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸™à¸µà¹‰à¸„à¹ˆà¸°\n\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "à¸¢à¸à¹€à¸¥à¸´à¸à¸¢à¸²" à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£`
    );
  }

  const drug = user.drugs[index];

  userStates[lineUserId] = {
    action: "confirmCancel",
    drugIndex: index,
  };

  return await reply(
    replyToken,
    `âš ï¸ à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸¥à¸šà¸¢à¸²\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’Š à¸¢à¸²: ${drug.name}\nğŸ“¦ à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­: ${drug.quantity} à¹€à¸¡à¹‡à¸”\n\nâ“ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸¢à¸²à¸™à¸µà¹‰à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?\n\nâœ… à¸à¸´à¸¡à¸à¹Œ "à¸¢à¸·à¸™à¸¢à¸±à¸™" à¸«à¸£à¸·à¸­ "à¹ƒà¸Šà¹ˆ" à¹€à¸à¸·à¹ˆà¸­à¸¥à¸š\nâŒ à¸à¸´à¸¡à¸à¹Œà¸­à¸¢à¹ˆà¸²à¸‡à¸­à¸·à¹ˆà¸™à¹€à¸à¸·à¹ˆà¸­à¸¢à¸à¹€à¸¥à¸´à¸`
  );
}

// ==================== Reminder Times ====================
async function handleShowTimes(replyToken, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user) {
    return await reply(replyToken, `âŒ à¸à¸£à¸¸à¸“à¸²à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸à¹ˆà¸­à¸™à¸„à¹ˆà¸°`);
  }

  const times = user.reminderTimes || ["08:00", "20:00"];

  let list = `â° à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²à¸‚à¸­à¸‡à¸„à¸¸à¸“:\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  times.forEach((t, i) => {
    list += `${i + 1}. ğŸ• ${t} à¸™.\n`;
  });
  list += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡:\nâ€¢ à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² [à¹€à¸§à¸¥à¸²]\nâ€¢ à¸¥à¸šà¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² [à¹€à¸¥à¸‚]\nâ€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² - à¸•à¸±à¹‰à¸‡à¸§à¹ˆà¸²à¸¢à¸²à¹„à¸«à¸™à¸à¸´à¸™à¹€à¸§à¸¥à¸²à¹„à¸«à¸™`;

  return await reply(replyToken, list);
}

async function handleAddTime(replyToken, text, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user) return;

  let time = text.replace("à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² ", "").trim().replace(".", ":");

  const parts = time.split(":");
  if (parts.length === 2) {
    time = `${parts[0].padStart(2, "0")}:${parts[1].padStart(2, "0")}`;
  }

  const regex = /^([01]?[0-9]|2[0-3]):([0-5][0-9])$/;
  if (!regex.test(time)) {
    return await reply(
      replyToken,
      `âŒ à¸£à¸¹à¸›à¹à¸šà¸šà¹€à¸§à¸¥à¸²à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¹ˆà¸°\n\nà¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡:\nâ€¢ à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 12:00\nâ€¢ à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 18.30`
    );
  }

  if (!user.reminderTimes) user.reminderTimes = ["08:00", "20:00"];

  if (user.reminderTimes.includes(time)) {
    return await reply(
      replyToken,
      `âŒ à¸¡à¸µà¹€à¸§à¸¥à¸² ${time} à¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°\n\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²" à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¹€à¸§à¸¥à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”`
    );
  }

  user.reminderTimes.push(time);
  user.reminderTimes.sort();
  await saveUser(lineUserId, user);

  const timeList = user.reminderTimes
    .map((t, i) => `${i + 1}. ${t}`)
    .join("\n");

  return await reply(
    replyToken,
    `âœ… à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â° à¹€à¸§à¸¥à¸²à¹ƒà¸«à¸¡à¹ˆ: ${time} à¸™.

ğŸ“‹ à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”:
${timeList}

ğŸ’¡ à¸•à¸±à¹‰à¸‡à¸§à¹ˆà¸²à¸¢à¸²à¹„à¸«à¸™à¸à¸´à¸™à¹€à¸§à¸¥à¸²à¹„à¸«à¸™:
à¸à¸´à¸¡à¸à¹Œ: à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²`
  );
}

async function handleRemoveTime(replyToken, text, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user) return;

  const index = parseInt(text.replace("à¸¥à¸šà¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² ", "").trim()) - 1;
  const times = user.reminderTimes || ["08:00", "20:00"];

  if (isNaN(index) || index < 0 || index >= times.length) {
    return await reply(
      replyToken,
      `âŒ à¹„à¸¡à¹ˆà¸à¸šà¹€à¸§à¸¥à¸²à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸™à¸µà¹‰à¸„à¹ˆà¸°\n\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²" à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¹€à¸§à¸¥à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”`
    );
  }

  if (times.length <= 1) {
    return await reply(
      replyToken,
      `âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¥à¸šà¹„à¸”à¹‰à¸„à¹ˆà¸°\n\nà¸•à¹‰à¸­à¸‡à¸¡à¸µà¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 1 à¹€à¸§à¸¥à¸²`
    );
  }

  const removed = times[index];
  user.reminderTimes.splice(index, 1);

  // à¸­à¸±à¸›à¹€à¸”à¸• schedules à¸‚à¸­à¸‡à¸¢à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
  user.drugs.forEach((drug) => {
    drug.schedules = drug.schedules.map((s) => {
      s.times = s.times.filter((t) => t !== index).map((t) => (t > index ? t - 1 : t));
      return s;
    }).filter((s) => s.times.length > 0);
  });

  await saveUser(lineUserId, user);

  const timeList = user.reminderTimes
    .map((t, i) => `${i + 1}. ${t}`)
    .join("\n");

  return await reply(
    replyToken,
    `âœ… à¸¥à¸šà¹€à¸§à¸¥à¸² ${removed} à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“‹ à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­:\n${timeList}`
  );
}

// ==================== Set Drug Schedule ====================
async function handleSetScheduleStart(replyToken, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user || user.drugs.length === 0) {
    return await reply(
      replyToken,
      `âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸¢à¸²à¹ƒà¸™à¸£à¸°à¸šà¸šà¸„à¹ˆà¸°\n\nğŸ’¡ à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²à¸à¹ˆà¸­à¸™:\nà¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² [à¸Šà¸·à¹ˆà¸­] [à¸ˆà¸³à¸™à¸§à¸™]`
    );
  }

  const times = user.reminderTimes || ["08:00", "20:00"];

  let msg = `â° à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ“‹ à¹€à¸§à¸¥à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”:\n`;
  times.forEach((t, i) => {
    msg += `${i + 1}. ğŸ• ${t} à¸™.\n`;
  });

  msg += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’Š à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¹à¸¥à¸°à¸•à¸²à¸£à¸²à¸‡à¸à¸´à¸™:\n`;

  user.drugs.forEach((drug, i) => {
    msg += `\n${i + 1}. ${drug.name} (${drug.quantity} à¹€à¸¡à¹‡à¸”)\n`;

    if (!drug.schedules || drug.schedules.length === 0) {
      msg += `   â° à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²\n`;
    } else {
      drug.schedules.forEach((s) => {
        const timeLabels = s.times.map((t) => t + 1).join(",");
        msg += `   â° à¹€à¸§à¸¥à¸² ${timeLabels} - à¸à¸´à¸™ ${s.pills} à¹€à¸¡à¹‡à¸”\n`;
      });
    }
  });

  msg += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ à¸§à¸´à¸˜à¸µà¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²:\n\n`;
  msg += `à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² [à¹€à¸§à¸¥à¸²] [à¹€à¸¥à¸‚à¸¢à¸²] [à¸ˆà¸³à¸™à¸§à¸™à¹€à¸¡à¹‡à¸”]\n\n`;
  msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“Œ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:\n\n`;
  msg += `â€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1 1 2\n`;
  msg += `  â†’ à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ 1, à¸¢à¸²à¹€à¸¥à¸‚ 1, à¸à¸´à¸™ 2 à¹€à¸¡à¹‡à¸”\n\n`;
  msg += `â€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1,2 3 1\n`;
  msg += `  â†’ à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ 1 à¹à¸¥à¸° 2, à¸¢à¸²à¹€à¸¥à¸‚ 3, à¸à¸´à¸™ 1 à¹€à¸¡à¹‡à¸”\n\n`;
  msg += `â€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1 1,2,3 1\n`;
  msg += `  â†’ à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆ 1, à¸¢à¸²à¹€à¸¥à¸‚ 1,2,3, à¸à¸´à¸™ 1 à¹€à¸¡à¹‡à¸”\n\n`;
  msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "help à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²" à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹€à¸à¸´à¹ˆà¸¡`;

  return await reply(replyToken, msg);
}

async function handleSetSchedule(replyToken, text, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user) return;

  const parts = text.replace("à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² ", "").trim().split(" ");

  if (parts.length < 3) {
    return await reply(
      replyToken,
      `âŒ à¸£à¸¹à¸›à¹à¸šà¸šà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¹ˆà¸°\n\nà¸à¸´à¸¡à¸à¹Œ: à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² [à¹€à¸§à¸¥à¸²] [à¹€à¸¥à¸‚à¸¢à¸²] [à¸ˆà¸³à¸™à¸§à¸™à¹€à¸¡à¹‡à¸”]\n\nà¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:\nâ€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1 1 2\nâ€¢ à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸² 1,2 3 1\n\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²" à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”`
    );
  }

  const timeInput = parts[0];
  const drugInput = parts[1];
  const pills = parseInt(parts[2]);

  if (isNaN(pills) || pills <= 0) {
    return await reply(
      replyToken,
      `âŒ à¸ˆà¸³à¸™à¸§à¸™à¹€à¸¡à¹‡à¸”à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¹ˆà¸°\nà¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 0`
    );
  }

  const times = user.reminderTimes || ["08:00", "20:00"];

  // à¹à¸›à¸¥à¸‡ "1,2" à¹€à¸›à¹‡à¸™ [0, 1]
  const selectedTimes = timeInput
    .split(",")
    .map((t) => parseInt(t.trim()) - 1)
    .filter((t) => !isNaN(t) && t >= 0 && t < times.length);

  if (selectedTimes.length === 0) {
    return await reply(
      replyToken,
      `âŒ à¹€à¸§à¸¥à¸²à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¹ˆà¸°\n\nà¹ƒà¸Šà¹‰à¹€à¸¥à¸‚ 1 à¸–à¸¶à¸‡ ${times.length}\nà¸«à¸£à¸·à¸­à¸„à¸±à¹ˆà¸™à¸”à¹‰à¸§à¸¢ , à¹€à¸Šà¹ˆà¸™ 1,2`
    );
  }

  // à¹à¸›à¸¥à¸‡ "1,2,3" à¹€à¸›à¹‡à¸™ [0, 1, 2]
  const selectedDrugs = drugInput
    .split(",")
    .map((d) => parseInt(d.trim()) - 1)
    .filter((d) => !isNaN(d) && d >= 0 && d < user.drugs.length);

  if (selectedDrugs.length === 0) {
    return await reply(
      replyToken,
      `âŒ à¹€à¸¥à¸‚à¸¢à¸²à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸„à¹ˆà¸°\n\nà¹ƒà¸Šà¹‰à¹€à¸¥à¸‚ 1 à¸–à¸¶à¸‡ ${user.drugs.length}\nà¸«à¸£à¸·à¸­à¸„à¸±à¹ˆà¸™à¸”à¹‰à¸§à¸¢ , à¹€à¸Šà¹ˆà¸™ 1,2,3`
    );
  }

  // à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹ƒà¸«à¹‰à¸¢à¸²à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸
  selectedDrugs.forEach((drugIdx) => {
    const drug = user.drugs[drugIdx];

    // à¸¥à¸š schedule à¹€à¸”à¸´à¸¡à¸‚à¸­à¸‡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸‹à¹‰à¸³à¸à¸±à¸™
    drug.schedules = (drug.schedules || []).filter((s) => {
      return !s.times.some((t) => selectedTimes.includes(t));
    });

    // à¹€à¸à¸´à¹ˆà¸¡ schedule à¹ƒà¸«à¸¡à¹ˆ
    drug.schedules.push({
      times: selectedTimes,
      pills: pills,
    });
  });

  await saveUser(lineUserId, user);

  const timeLabels = selectedTimes.map((t) => `${t + 1}. ${times[t]}`).join("\n");
  const drugLabels = selectedDrugs
    .map((d) => `${d + 1}. ${user.drugs[d].name}`)
    .join("\n");

  return await reply(
    replyToken,
    `âœ… à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â° à¹€à¸§à¸¥à¸²:
${timeLabels}

ğŸ’Š à¸¢à¸²:
${drugLabels}

ğŸ“¦ à¸ˆà¸³à¸™à¸§à¸™: ${pills} à¹€à¸¡à¹‡à¸”/à¸„à¸£à¸±à¹‰à¸‡

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²" à¸”à¸¹à¸•à¸²à¸£à¸²à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”`
  );
}

// ==================== Take Drug ====================
async function handleLateStart(replyToken, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user) return;

  const times = user.reminderTimes || ["08:00", "20:00"];

  let list = `â° à¹€à¸¥à¸·à¸­à¸à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸²:\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  times.forEach((t, i) => {
    list += `${i + 1}. ğŸ• ${t} à¸™.\n`;
  });
  list += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ à¸à¸´à¸¡à¸à¹Œ: à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸² [à¹€à¸¥à¸‚]\nà¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸² 1\n\nğŸ’¡ à¹ƒà¸Šà¹‰à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸™à¸µà¹‰à¹€à¸¡à¸·à¹ˆà¸­à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸²à¹€à¸à¸´à¸™ 30 à¸™à¸²à¸—à¸µ`;

  return await reply(replyToken, list);
}

async function handleTakeDrug(replyToken, text, lineUserId, isLate) {
  const user = await getUser(lineUserId);
  if (!user) {
    return await reply(replyToken, `âŒ à¸à¸£à¸¸à¸“à¸²à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸à¹ˆà¸­à¸™à¸„à¹ˆà¸°`);
  }

  const cmd = isLate ? "à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸² " : "à¸à¸´à¸™à¸¢à¸² ";
  const index = parseInt(text.replace(cmd, "").trim()) - 1;
  const times = user.reminderTimes || ["08:00", "20:00"];

  if (isNaN(index) || index < 0 || index >= times.length) {
    return await reply(
      replyToken,
      `âŒ à¹„à¸¡à¹ˆà¸à¸šà¹€à¸§à¸¥à¸²à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸™à¸µà¹‰à¸„à¹ˆà¸°\n\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "${
        isLate ? "à¸à¸´à¸™à¸¢à¸²à¸Šà¹‰à¸²" : "à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²"
      }" à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£`
    );
  }

  if (user.drugs.length === 0) {
    return await reply(
      replyToken,
      `âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸¢à¸²à¹ƒà¸™à¸£à¸°à¸šà¸šà¸„à¹ˆà¸°\n\nğŸ’¡ à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²à¸à¹ˆà¸­à¸™:\nà¹€à¸à¸´à¹ˆà¸¡à¸¢à¸² [à¸Šà¸·à¹ˆà¸­à¸¢à¸²] [à¸ˆà¸³à¸™à¸§à¸™]`
    );
  }

  // à¸à¸£à¸­à¸‡à¹€à¸‰à¸à¸²à¸°à¸¢à¸²à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸´à¸™à¹€à¸§à¸¥à¸²à¸™à¸µà¹‰
  let status = "";
  let hasDrugs = false;

  user.drugs.forEach((drug) => {
    const schedule = (drug.schedules || []).find((s) => s.times.includes(index));

    if (schedule) {
      hasDrugs = true;
      const pills = schedule.pills || 1;

      if (drug.quantity >= pills) {
        drug.quantity -= pills;

        let icon = "ğŸ’Š";
        const dailyUse = drug.schedules.reduce((sum, s) => sum + (s.pills || 1), 0);

        if (drug.quantity <= 0) icon = "ğŸš«";
        else if (drug.quantity <= dailyUse * 5) icon = "ğŸ”´";
        else if (drug.quantity <= dailyUse * 10) icon = "ğŸŸ¡";

        status += `${icon} ${drug.name}: à¸à¸´à¸™ ${pills} à¹€à¸¡à¹‡à¸” (à¹€à¸«à¸¥à¸·à¸­ ${drug.quantity} à¹€à¸¡à¹‡à¸”)\n`;
      } else {
        status += `ğŸš« ${drug.name}: à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§ (à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ ${pills} à¹€à¸¡à¹‡à¸”)!\n`;
      }
    }
  });

  if (!hasDrugs) {
    return await reply(
      replyToken,
      `ğŸ“‹ à¹„à¸¡à¹ˆà¸¡à¸µà¸¢à¸²à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸´à¸™à¹€à¸§à¸¥à¸² ${times[index]} à¸™.\n\nğŸ’¡ à¸à¸´à¸¡à¸à¹Œ "à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²" à¹€à¸à¸·à¹ˆà¸­à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²`
    );
  }

  await saveUser(lineUserId, user);

  const lateText = isLate ? " (à¸à¸´à¸™à¸Šà¹‰à¸²)" : "";
  const now = new Date();
  const dateStr = now.toLocaleDateString("th-TH", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });

  return await reply(
    replyToken,
    `âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸à¸´à¸™à¸¢à¸²à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!${lateText}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ° à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²: ${times[index]} à¸™.\nğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ: ${dateStr}\n\nğŸ“Š à¸ªà¸–à¸²à¸™à¸°à¸¢à¸²à¸«à¸¥à¸±à¸‡à¸à¸´à¸™:\n${status}`
  );
}

// ==================== Reset ====================
async function handleResetStart(replyToken, lineUserId) {
  const user = await getUser(lineUserId);
  if (!user) {
    return await reply(
      replyToken,
      `âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸£à¸°à¸šà¸šà¸„à¹ˆà¸°\n\nà¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹€à¸£à¸´à¹ˆà¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™:\nà¸à¸´à¸¡à¸à¹Œ: à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ [à¸£à¸«à¸±à¸ªà¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢]`
    );
  }

  userStates[lineUserId] = {
    action: "confirmReset",
  };

  return await reply(
    replyToken,
    `âš ï¸ à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸£à¸µà¹€à¸‹à¹‡à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ—‘ï¸ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ˆà¸°à¸–à¸¹à¸à¸¥à¸š:

âŒ à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²: ${user.drugs.length} à¸£à¸²à¸¢à¸à¸²à¸£
âŒ à¹€à¸§à¸¥à¸²à¸à¸´à¸™à¸¢à¸²: ${user.reminderTimes.length} à¹€à¸§à¸¥à¸²
âŒ à¸•à¸²à¸£à¸²à¸‡à¸à¸´à¸™à¸¢à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
âŒ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ à¸„à¸³à¹€à¸•à¸·à¸­à¸™à¸ªà¸³à¸„à¸±à¸!

à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸¥à¸šà¹à¸¥à¹‰à¸§à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸à¸¹à¹‰à¸„à¸·à¸™à¹„à¸”à¹‰
à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸à¹ˆà¸­à¸™à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â“ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸£à¸µà¹€à¸‹à¹‡à¸—à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?

âœ… à¸à¸´à¸¡à¸à¹Œ "à¸¢à¸·à¸™à¸¢à¸±à¸™à¸£à¸µà¹€à¸‹à¹‡à¸—" à¹€à¸à¸·à¹ˆà¸­à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
âŒ à¸à¸´à¸¡à¸à¹Œà¸­à¸¢à¹ˆà¸²à¸‡à¸­à¸·à¹ˆà¸™à¹€à¸à¸·à¹ˆà¸­à¸¢à¸à¹€à¸¥à¸´à¸`
  );
}

async function handleResetConfirm(replyToken, lineUserId) {
  // Handled in handleUserState
  return null;
}

// ==================== Webhook ====================
app.post("/webhook", async (req, res) => {
  res.sendStatus(200);

  const events = req.body.events || [];
  for (const event of events) {
    if (event.type === "message" && event.message.type === "text") {
      await handleMessage(event);
    }
  }
});

app.get("/", (req, res) => {
  res.send("ğŸ¥ Medicine LINE Bot is running!");
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ğŸš€ Server running on port ${PORT}`);
  startReminderSystem();
});